name: Deploy Database (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
    secrets:
      GCP_SA_KEY:
        required: true
      GCP_PROJECT_ID:
        required: true
      SUPABASE_ACCESS_TOKEN:
        required: true
      SUPABASE_DB_PASSWORD:
        required: true
      SUPABASE_PROJECT_ID:
        required: true

jobs:
  deploy-database:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
      
      - name: Download seed files
        working-directory: ./backend
        run: |
          ENVIRONMENT=${{ inputs.environment }}
          # Only staging seed file exists; use it for all environments
          echo "Downloading seed file (staging version used for all environments)..."
          if gsutil cp gs://seed_files/seed.staging.sql supabase/seeds/seed.local.sql 2>/dev/null; then
            echo "‚úÖ Successfully downloaded seed file from GCS"
          else
            echo "‚ö†Ô∏è  Seed file not found in GCS bucket (gs://seed_files/seed.staging.sql)"
            echo "‚ö†Ô∏è  Deployment will continue using seed files from repository if available"
          fi
      
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
      
      - name: Deploy database migrations and seeds
        working-directory: ./backend
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          ENVIRONMENT=${{ inputs.environment }}
          SUPABASE_PROJECT_ID="${{ secrets.SUPABASE_PROJECT_ID }}"
          
          if [ -z "$SUPABASE_PROJECT_ID" ]; then
            echo "‚ö†Ô∏è  SUPABASE_PROJECT_ID not set, skipping database deployment"
            exit 0
          fi
          
          if [ -z "$SUPABASE_DB_PASSWORD" ]; then
            echo "‚ùå ERROR: SUPABASE_DB_PASSWORD not set"
            exit 1
          fi
          
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "‚ùå ERROR: SUPABASE_ACCESS_TOKEN not set"
            exit 1
          fi
          
          echo "üîó Linking to Supabase project: $SUPABASE_PROJECT_ID"
          echo "üìù Using environment: $ENVIRONMENT"
          
          # Link with explicit password flag
          supabase link --project-ref "$SUPABASE_PROJECT_ID" --password "$SUPABASE_DB_PASSWORD" || {
            echo "‚ùå Failed to link to Supabase project"
            echo "üí° Troubleshooting tips:"
            echo "   1. Verify SUPABASE_DB_PASSWORD is correct in GitHub Secrets"
            echo "   2. Check that the password doesn't contain special characters that need escaping"
            echo "   3. Ensure the Supabase project ID is correct: $SUPABASE_PROJECT_ID"
            echo "   4. Verify the database is accessible from GitHub Actions runners"
            exit 1
          }
          
          echo "‚úÖ Successfully linked to Supabase project"
          
          if [ "$ENVIRONMENT" = "staging" ]; then
            echo "üîÑ Resetting staging database (with seeds)..."
            echo "y" | supabase db reset --linked || {
              echo "‚ùå Failed to reset staging database"
              exit 1
            }
            echo "üì§ Pushing database changes including seeds..."
            supabase db push --include-seed || {
              echo "‚ùå Failed to push database changes with seeds"
              exit 1
            }
          else
            echo "üì§ Running production migrations only (no reset, no seeds)..."
            supabase db push || {
              echo "‚ùå Failed to push production database changes"
              exit 1
            }
          fi
          
          echo "‚úÖ Database deployment completed successfully"

