name: Deploy Cloud Run Services


on:
  push:
    branches:
      - staging
      - main
    paths:
      - '.github/workflows/deploy-cloud-run.yml'
      - '.github/workflows/deploy-to-gcp.yml'
      - 'backend/**'
      - 'frontend/**'
      - 'visualizer/**'
  workflow_dispatch:
    inputs:
      deploy_frontend:
        description: 'Deploy frontend service'
        required: false
        default: true
        type: boolean
      deploy_backend:
        description: 'Deploy backend service'
        required: false
        default: true
        type: boolean
      deploy_visualizer:
        description: 'Deploy visualizer service'
        required: false
        default: true
        type: boolean

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend_changed: ${{ steps.filter.outputs.frontend }}
      backend_changed: ${{ steps.filter.outputs.backend }}
      visualizer_changed: ${{ steps.filter.outputs.visualizer }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Check for changes
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            frontend:
              - 'frontend/**'
            backend:
              - 'backend/**'
            visualizer:
              - 'visualizer/**'
      
      - name: Debug outputs
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Frontend changed: ${{ steps.filter.outputs.frontend }}"
          echo "Backend changed: ${{ steps.filter.outputs.backend }}"
          echo "Visualizer changed: ${{ steps.filter.outputs.visualizer }}"
          echo "Changes detected: ${{ steps.filter.outputs.changes }}"

  deploy-all:
    needs: check-changes
    if: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
    uses: ./.github/workflows/deploy-to-gcp.yml
    with:
      environment: ${{ github.ref_name == 'main' && 'prod' || 'staging' }}
      deploy_frontend: ${{ (github.event_name == 'push' && needs.check-changes.outputs.frontend_changed == 'true') || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_frontend == 'true') }}
      deploy_backend: ${{ (github.event_name == 'push' && needs.check-changes.outputs.backend_changed == 'true') || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_backend == 'true') }}
      deploy_visualizer: ${{ (github.event_name == 'push' && needs.check-changes.outputs.visualizer_changed == 'true') || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_visualizer == 'true') }}
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      SIGNING_SA_CREDENTIALS: ${{ secrets.SIGNING_SA_CREDENTIALS }}
      # Supabase Configuration
      SUPABASE_URL: ${{ github.ref_name == 'main' && secrets.PROD_SUPABASE_URL || secrets.STAGING_SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE: ${{ github.ref_name == 'main' && secrets.PROD_SUPABASE_SERVICE_ROLE || secrets.STAGING_SUPABASE_SERVICE_ROLE }}
      SUPABASE_ANON_KEY: ${{ github.ref_name == 'main' && secrets.PROD_SUPABASE_ANON_KEY || secrets.STAGING_SUPABASE_ANON_KEY }}
      # Encryption
      ENCRYPTION_KEY: ${{ github.ref_name == 'main' && secrets.PROD_ENCRYPTION_KEY || secrets.STAGING_ENCRYPTION_KEY }}
      ENCRYPTION_SALT: ${{ github.ref_name == 'main' && secrets.PROD_ENCRYPTION_SALT || secrets.STAGING_ENCRYPTION_SALT }}
      # External Services
      DDX_API_BASE_URL: ${{ github.ref_name == 'main' && secrets.PROD_DDX_API_BASE_URL || secrets.STAGING_DDX_API_BASE_URL }}
      # Storage
      BUCKET_NAME: ${{ github.ref_name == 'main' && secrets.PROD_BUCKET_NAME || secrets.STAGING_BUCKET_NAME }}
      # Optional: Override the default frontend URL (if not provided, will be auto-generated)
      REDIRECT_URL: ${{ github.ref_name == 'main' && secrets.PROD_REDIRECT_URL || secrets.STAGING_REDIRECT_URL }}
      # Database Deployment
      SUPABASE_ACCESS_TOKEN: ${{ github.ref_name == 'main' && secrets.PROD_SUPABASE_ACCESS_TOKEN || secrets.STAGING_SUPABASE_ACCESS_TOKEN }}
      SUPABASE_DB_PASSWORD: ${{ github.ref_name == 'main' && secrets.PROD_SUPABASE_DB_PASSWORD || secrets.STAGING_SUPABASE_DB_PASSWORD }}
      SUPABASE_PROJECT_ID: ${{ github.ref_name == 'main' && secrets.PROD_SUPABASE_PROJECT_ID || secrets.STAGING_SUPABASE_PROJECT_ID }}
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}